<!DOCTYPE html>
<html lang="pl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miesiƒôczny Panel Bud≈ºetu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        ::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:#1f2937}::-webkit-scrollbar-thumb{background:#4b5563;border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#6b7280}
        .progress-bar{background-color:#374151}.progress{height:100%;border-radius:0.25rem;transition:width 0.3s ease-in-out}
        .budget-value{cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-decoration-color:#9ca3af}.budget-value:hover{text-decoration-color:#f9fafb;color:#f9fafb}
        .delete-trans-btn{font-size:1.5rem;font-weight:bold;line-height:1;padding:0.25rem 0.5rem;border-radius:0.375rem;transition:background-color 0.2s}.delete-trans-btn:hover{background-color:#374151}
        .modal-overlay{transition:opacity 0.3s ease}.modal-content{transition:transform 0.3s ease}
        .settings-btn{background-color:#374151;border:1px solid #4b5563;color:white;padding:0.5rem;border-radius:0.5rem;cursor:pointer;font-size:1rem;line-height:1;transition:background-color 0.2s}.settings-btn:hover{background-color:#4b5563}.settings-btn.active{background-color:#14b8a6;border-color:#14b8a6}
        .fab{position:fixed;bottom:2rem;right:2rem;width:4rem;height:4rem;border-radius:9999px;background-color:#14b8a6;color:white;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);cursor:pointer;transition:transform 0.2s ease-out;z-index:40}.fab:hover{transform:scale(1.05);background-color:#0d9488}.fab svg{width:2rem;height:2rem}
    </style>
    
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { 'brand-pink': '#ec4899', 'brand-purple': '#a855f7', 'brand-teal': '#14b8a6' } } } }
    </script>
</head>
<body class="bg-gray-900 text-gray-200 font-sans p-4 sm:p-8 antialiased">

    <div id="auth-container" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="flex justify-center gap-4 mb-6">
                 <div class="flex items-center space-x-1 bg-gray-800 p-1 rounded-lg"><button id="auth-lang-pl" class="settings-btn active">üáµüá±</button><button id="auth-lang-en" class="settings-btn">üá¨üáß</button></div>
                 <div class="flex items-center space-x-1 bg-gray-800 p-1 rounded-lg"><button id="auth-curr-pln" class="settings-btn active">PLN</button><button id="auth-curr-eur" class="settings-btn">EUR</button></div>
            </div>
            <h2 class="text-3xl font-bold text-white text-center mb-6" data-i18n-key="welcome">Witaj</h2>
            <div class="bg-gray-800 p-8 rounded-2xl shadow-lg">
                <form id="login-form" class="space-y-4 mb-4">
                    <h3 class="text-xl font-semibold text-white" data-i18n-key="login">Zaloguj siƒô</h3>
                    <div><label class="block text-sm font-medium text-gray-300" data-i18n-key="email">Email</label><input type="email" id="login-email" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></div>
                    <div><label class="block text-sm font-medium text-gray-300" data-i18n-key="password">Has≈Ço</label><input type="password" id="login-password" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></div>
                    <div class="flex flex-col gap-2">
                        <button type="submit" class="w-full bg-brand-teal hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow" data-i18n-key="loginBtn">Zaloguj siƒô</button>
                        <button type="button" id="forgot-password-btn" class="text-sm text-brand-teal hover:text-teal-400 mt-1" data-i18n-key="forgotPassword">Zapomnia≈Çe≈õ has≈Ça?</button>
                    </div>
                </form>
                <form id="register-form" class="space-y-4">
                    <h3 class="text-xl font-semibold text-white" data-i18n-key="register">Lub utw√≥rz konto</h3>
                    <div><label class="block text-sm font-medium text-gray-300" data-i18n-key="name">Imiƒô</label><input type="text" id="register-name" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></div>
                    <div><label class="block text-sm font-medium text-gray-300" data-i18n-key="email">Email</label><input type="email" id="register-email" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></div>
                    <div><label class="block text-sm font-medium text-gray-300" data-i18n-key="password">Has≈Ço</label><input type="password" id="register-password" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></div>
                    <button type="submit" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow" data-i18n-key="registerBtn">Zarejestruj siƒô</button>
                </form>
                <p id="auth-error" class="text-red-400 text-sm mt-4 text-center hidden"></p>
                <p id="auth-success" class="text-teal-400 text-sm mt-4 text-center hidden"></p>
            </div>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto hidden">
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2"><select id="budget-select" class="bg-gray-900 text-white text-2xl sm:text-3xl font-bold border-0 focus:ring-0 p-0 pr-8 cursor-pointer hover:text-brand-teal transition-colors"></select></div>
            <div class="flex flex-wrap justify-center sm:justify-end items-center gap-2">
                <div class="flex items-center space-x-1 bg-gray-800 p-1 rounded-lg"><button id="lang-pl" class="settings-btn active">üáµüá±</button><button id="lang-en" class="settings-btn">üá¨üáß</button></div>
                 <div class="flex items-center space-x-1 bg-gray-800 p-1 rounded-lg"><button id="curr-pln" class="settings-btn active">PLN</button><button id="curr-eur" class="settings-btn">EUR</button></div>
                <select id="filter-user-select" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg p-2.5"></select>
                <select id="month-select" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg p-2.5"></select>
                <select id="year-select" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg p-2.5"></select>
                <button id="logout-btn" class="text-sm bg-gray-700 hover:bg-gray-600 text-white font-medium py-2.5 px-4 rounded-lg shadow" data-i18n-key="logout">Wyloguj</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h2 class="text-sm font-medium text-gray-400 mb-1" data-i18n-key="leftToSpend">Pozosta≈Ço</h2>
                        <p id="summary-left-to-spend" class="text-4xl font-bold text-white">0,00 z≈Ç</p>
                        <p class="text-sm text-gray-400 mt-2"><span id="summary-spent-so-far">0,00 z≈Ç</span> <span data-i18n-key="spentOf">wydano z</span> <span id="summary-total-income">0,00 z≈Ç</span></p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h2 class="text-sm font-medium text-gray-400 mb-1" data-i18n-key="totalIncome">Przychody</h2>
                        <p id="summary-income-actual" class="text-4xl font-bold text-brand-teal">0,00 z≈Ç</p>
                        <p class="text-sm text-gray-400 mt-2"><span data-i18n-key="budgeted">Plan</span>: <span id="summary-income-budgeted">0,00 z≈Ç</span></p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h2 class="text-sm font-medium text-gray-400 mb-1" data-i18n-key="budgetVsActual">Plan vs Wydatki</h2>
                        <p id="summary-expenses-actual" class="text-4xl font-bold text-brand-pink">0,00 z≈Ç</p>
                        <p class="text-sm text-gray-400 mt-2"><span data-i18n-key="budgeted">Plan</span>: <span id="summary-expenses-budgeted">0,00 z≈Ç</span></p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-lg h-[400px] flex flex-col"><h2 class="text-lg font-semibold text-white mb-4" data-i18n-key="spendingAnalysis">Analiza</h2><div class="relative flex-grow h-full"><canvas id="spendingDoughnutChart"></canvas></div></div>
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-lg h-[400px] flex flex-col"><h2 class="text-lg font-semibold text-white mb-4" data-i18n-key="budgetVsSpent">Bud≈ºet vs. Wydatki</h2><div class="relative flex-grow h-full"><canvas id="budgetBarChart"></canvas></div></div>
                </div>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-lg font-semibold text-white" data-i18n-key="budgetCategories">Kategorie</h2>
                        <div class="flex flex-wrap gap-2 justify-center">
                            <button id="manage-budget-btn" class="text-sm bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg shadow" data-i18n-key="manageBudget">Bud≈ºet</button>
                            <button id="yearly-summary-btn" class="text-sm bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg shadow" data-i18n-key="yearlySummary">Podsumowanie</button>
                            <button id="manage-categories-btn" class="text-sm bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg shadow" data-i18n-key="manageCategories">Kategorie</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-x-8 gap-y-6">
                        <div id="income-table-container"></div><div id="expenses-table-container"></div><div id="bills-table-container"></div><div id="debt-table-container"></div><div id="savings-table-container"></div>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-lg font-semibold text-white mb-4" data-i18n-key="recentTransactions">Ostatnie Transakcje</h2>
                    <div id="transaction-list-container" class="space-y-4 max-h-[1200px] lg:max-h-[1700px] overflow-y-auto pr-2"><p id="no-transactions" class="text-gray-400" data-i18n-key="noTransactions">Brak transakcji.</p></div>
                </div>
            </div>
        </div>
    </div>
    <button id="fab-add-transaction" class="fab hidden" title="Dodaj Transakcjƒô"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg></button>

    <!-- MODALE -->
    <div id="transaction-modal" class="modal-overlay fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-gray-800 w-full max-w-lg rounded-2xl shadow-lg p-6 max-h-[90vh] flex flex-col transform scale-95 opacity-0">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white" data-i18n-key="addTransaction">Dodaj Transakcjƒô</h2><button id="close-transaction-modal" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="transaction-form" class="space-y-4 overflow-y-auto pr-2">
                <div id="message-box" class="p-4 text-sm rounded-lg hidden"></div>
                <div><label class="block text-sm font-medium text-gray-300" data-i18n-key="description">Opis</label><input type="text" id="trans-description" name="trans-description" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></div>
                <div><label class="block text-sm font-medium text-gray-300" data-i18n-key="amount">Kwota</label><input type="number" id="trans-amount" name="trans-amount" step="0.01" min="0" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></div>
                <div><label class="block text-sm font-medium text-gray-300" data-i18n-key="category">Kategoria</label><select id="trans-category" name="trans-category" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></select></div>
                <div><label class="block text-sm font-medium text-gray-300" data-i18n-key="date">Data</label><input type="date" id="trans-date" name="trans-date" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></div>
                <button type="submit" class="w-full bg-brand-teal hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow" data-i18n-key="addTransactionBtn">Dodaj</button>
            </form>
        </div>
    </div>
    <div id="category-manager-modal" class="modal-overlay fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-gray-800 w-full max-w-lg rounded-2xl shadow-lg p-6 max-h-[90vh] flex flex-col transform scale-95 opacity-0">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white" data-i18n-key="manageCategoriesTitle">Kategorie</h2><button id="close-category-modal" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <div class="mb-4"><button id="force-seed-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold py-2 px-4 rounded-lg shadow mb-4">Przywr√≥ƒá Domy≈õlne Kategorie (Naprawa)</button></div>
            <form id="category-form" class="space-y-4 p-4 border border-gray-700 rounded-lg mb-4">
                <div><label class="block text-sm font-medium text-gray-300" data-i18n-key="name">Nazwa</label><input type="text" id="cat-form-name" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-300" data-i18n-key="defaultBudget">Bud≈ºet</label><input type="number" id="cat-form-budgeted" step="0.01" min="0" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></div>
                    <div><label class="block text-sm font-medium text-gray-300" data-i18n-key="type">Typ</label><select id="cat-form-type" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></select></div>
                </div>
                <button type="submit" id="cat-form-submit" class="w-full bg-brand-teal hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow" data-i18n-key="addCategoryBtn">Dodaj</button>
                <button type="button" id="cat-form-cancel" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow hidden" data-i18n-key="cancelEditBtn">Anuluj</button>
            </form>
            <div id="category-manager-list" class="space-y-2 overflow-y-auto pr-2"></div>
        </div>
    </div>
    <div id="yearly-summary-modal" class="modal-overlay fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-gray-800 w-full max-w-3xl rounded-2xl shadow-lg p-6 max-h-[90vh] flex flex-col transform scale-95 opacity-0">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><h2 class="text-xl font-semibold text-white" id="yearly-summary-title">Podsumowanie</h2><button id="export-csv-btn" class="text-sm bg-brand-teal hover:bg-teal-600 text-white font-medium py-2 px-4 rounded-lg shadow" data-i18n-key="exportCSV">CSV</button><button id="close-yearly-modal" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <div class="overflow-y-auto pr-2"><table class="w-full text-left"><thead class="bg-gray-700"><tr><th class="p-3 text-sm font-semibold text-white" data-i18n-key="month">MiesiƒÖc</th><th class="p-3 text-sm font-semibold text-white" data-i18n-key="totalIncome">Przychody</th><th class="p-3 text-sm font-semibold text-white" data-i18n-key="totalExpenses">Wydatki</th><th class="p-3 text-sm font-semibold text-white" data-i18n-key="savings">Oszczƒôdno≈õci</th></tr></thead><tbody id="yearly-summary-table-body" class="divide-y divide-gray-700"></tbody><tfoot class="bg-gray-700 font-bold"><tr id="yearly-summary-table-footer"></tr></tfoot></table></div>
        </div>
    </div>
    <div id="budget-manager-modal" class="modal-overlay fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-gray-800 w-full max-w-lg rounded-2xl shadow-lg p-6 max-h-[90vh] flex flex-col transform scale-95 opacity-0">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-white" data-i18n-key="manageBudgetTitle">Bud≈ºet</h2><button id="close-budget-modal" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
            <form id="budget-name-form" class="space-y-2 mb-4"><label class="block text-sm font-medium text-gray-300" data-i18n-key="budgetName">Nazwa</label><div class="flex gap-2"><input type="text" id="budget-form-name" required class="flex-grow block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"><button type="submit" class="bg-brand-teal hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow" data-i18n-key="saveBtn">Zapisz</button></div></form>
            <hr class="border-gray-700 my-4"><h3 class="text-lg font-semibold text-white mb-2" data-i18n-key="createNewBudget">Nowy Bud≈ºet</h3><form id="create-budget-form" class="space-y-2 mb-4"><div class="flex gap-2"><input type="text" id="new-budget-name" required class="flex-grow block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" data-i18n-key="newBudgetPlaceholder" placeholder="np. Wakacje"><button type="submit" class="bg-brand-purple hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow" data-i18n-key="createBtn">Utw√≥rz</button></div></form>
            <hr class="border-gray-700 my-4"><h3 class="text-lg font-semibold text-white mb-2" data-i18n-key="inviteUser">Zapro≈õ</h3><p class="text-sm text-gray-400 mb-2" data-i18n-key="inviteUserDesc">Podaj email osoby zarejestrowanej.</p><form id="invite-user-form" class="space-y-2 mb-4"><label class="block text-sm font-medium text-gray-300" data-i18n-key="email">Email</label><div class="flex gap-2"><input type="email" id="invite-email" required class="flex-grow block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"><button type="submit" class="bg-brand-teal hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow" data-i18n-key="inviteBtn">Zapro≈õ</button></div><p id="invite-message" class="text-sm mt-2 hidden"></p></form>
            <div id="demo-data-section" class="hidden"><hr class="border-gray-700 my-4"><div class="flex justify-center"><button id="load-demo-data-btn" class="text-sm bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow">Wgraj Dane z Listopada 2025</button></div></div>
            <hr class="border-gray-700 my-4"><h3 class="text-lg font-semibold text-white mb-2" data-i18n-key="usersInBudget">U≈ºytkownicy</h3><div id="budget-user-list" class="space-y-2 overflow-y-auto pr-2 max-h-32"></div>
            <hr class="border-gray-700 my-4"><div class="bg-red-900/20 p-4 rounded-lg border border-red-900"><h3 class="text-lg font-semibold text-red-500 mb-2" data-i18n-key="dangerZone">Strefa Niebezpieczna</h3><p class="text-sm text-gray-400 mb-4" data-i18n-key="deleteBudgetDesc">Usuniƒôcie jest nieodwracalne.</p><button id="delete-budget-btn" class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow" data-i18n-key="deleteBudgetBtn">Usu≈Ñ Bud≈ºet</button></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const firebaseConfig = {
                apiKey: "AIzaSyALc9fMeTrLKHGrImqYumKpq0QbuUkJ0Yc",
                authDomain: "budgeting-app-25c25.firebaseapp.com",
                projectId: "budgeting-app-25c25",
                storageBucket: "budgeting-app-25c25.firebasestorage.app",
                messagingSenderId: "513641657698",
                appId: "1:513641657698:web:eafab8afdb3db3fec0683b",
                measurementId: "G-D6JH4LEH3R"
            };

            // Deklaracje zmiennych NA SAMYM G√ìRZE
            const containerIds = ['income-table-container', 'expenses-table-container', 'bills-table-container', 'debt-table-container', 'savings-table-container'];
            let app, auth, db;
            let currentLang = 'pl', currentCurrency = 'PLN', currentFilterUserId = null, currentMonthKey = '', currentUser = null, currentBudgetId = null;
            let userBudgets = [], localUsers = {}, localBudgetMembers = [], localTransactions = [], localCategories = [], localMonthlyBudgets = {};
            let spendingDoughnutChart, budgetBarChart;
            let editingCatId = null;
            let unsubscribeAuth, unsubscribeBudgetsList, unsubscribeActiveBudget;

            try { app = firebase.initializeApp(firebaseConfig); auth = firebase.auth(); db = firebase.firestore(); } catch (e) { console.error(e); }

            // --- FUNKCJE POMOCNICZE ---
            const translations={pl:{welcome:"Witaj w Bud≈ºecie Online",login:"Zaloguj siƒô",register:"Lub utw√≥rz nowe konto",email:"Email",password:"Has≈Ço",name:"Imiƒô",loginBtn:"Zaloguj siƒô",registerBtn:"Zarejestruj siƒô",logout:"Wyloguj",authErrorLogin:"B≈ÇƒÖd logowania",authErrorRegister:"B≈ÇƒÖd rej.",exportCSV:"Eksport CSV",defaultBudget:"M√≥j Bud≈ºet",dashboardTitle:'Bud≈ºet Domowy',leftToSpend:'Pozosta≈Ço do wydania',totalIncome:'Ca≈Çkowity Przych√≥d',totalExpenses:'Ca≈Çkowite Wydatki',spendingAnalysis:'Analiza Wydatk√≥w',budgetVsSpent:'Bud≈ºet vs. Wydatki',budgetCategories:'Kategorie Bud≈ºetowe',addTransaction:'Dodaj Transakcjƒô',recentTransactions:'Ostatnie Transakcje',manageBudget:'ZarzƒÖdzaj Bud≈ºetem',yearlySummary:'Podsumowanie Roczne',manageCategories:'ZarzƒÖdzaj Kategoriami',addTransactionBtn:'Dodaj Transakcjƒô',description:'Opis',descriptionPlaceholder:'np. Zakupy',amount:'Kwota',category:'Kategoria',selectCategory:'Wybierz...',date:'Data',noTransactions:'Brak transakcji.',spentOf:'wydano z',budgeted:'Zabud≈ºetowano',manageCategoriesTitle:'Kategorie',manageBudgetTitle:'Bud≈ºet',newCategoryPlaceholder:'np. Nowa',addCategoryBtn:'Dodaj',cancelEditBtn:'Anuluj',saveChangesBtn:'Zapisz',edit:'Edytuj',delete:'Usu≈Ñ',yearlySummaryTitle:'Podsumowanie',month:'MiesiƒÖc',savings:'Oszczƒôdno≈õci',total:'≈ÅƒÑCZNIE',transactionAdded:'Dodano!',transactionDeleted:'Usuniƒôto.',budgetUpdated:'Zaktualizowano.',invalidAmount:'B≈Çƒôdna kwota.',categoryAdded:'Dodano.',categoryUpdated:'Zaktualizowano.',categoryDeleted:'Usuniƒôto.',categoryDeleteError:'Ma transakcje.',fillAllFields:'Wype≈Çnij pola.',invalidCategory:'Wybierz kat.',newMonthSheet:'Nowy miesiƒÖc.',confirmDelete:'Na pewno?',chartBudgeted:'Zabud≈ºetowano',chartSpent:'Wydano',catTypeIncome:'Przych√≥d',catTypeExpense:'Wydatek',catTypeBill:'Rachunek',catTypeDebt:'D≈Çug',catTypeSavings:'Oszczƒôdno≈õci',catGroupIncome:'Przychody',catGroupExpense:'Wydatki',catGroupBill:'Rachunki',catGroupDebt:'D≈Çugi',catGroupSavings:'Oszczƒôdno≈õci',monthNames:["Stycze≈Ñ","Luty","Marzec","Kwiecie≈Ñ","Maj","Czerwiec","Lipiec","Sierpie≈Ñ","Wrzesie≈Ñ","Pa≈∫dziernik","Listopad","Grudzie≈Ñ"],unknownUser:'Nieznany',deletedCategory:'Usuniƒôta',transactionSaveError:'B≈ÇƒÖd zapisu.',clickToEditBudget:'Kliknij by edytowaƒá',deleteTransactionTooltip:'Usu≈Ñ',budgetFor:'Bud≈ºet dla',allUsers:'Wszyscy U≈ºytkownicy',langPlTooltip:'PL',langEnTooltip:'EN',currPlnTooltip:'PLN',currEurTooltip:'EUR',personalBudget:'Osobisty',budgetName:'Nazwa',saveBtn:'Zapisz',inviteUser:'Zapro≈õ',inviteUserDesc:'Podaj email.',inviteBtn:'Zapro≈õ',usersInBudget:'U≈ºytkownicy',inviteSuccess:'Zaproszono!',inviteErrorUserNotFound:'Brak.',inviteErrorAlreadyMember:'Ju≈º jest.',inviteErrorGeneric:'B≈ÇƒÖd.',budgetNameUpdated:'Zmieniono.',dangerZone:'Strefa Niebezpieczna',deleteBudgetDesc:'Trwa≈Çe usuniƒôcie.',deleteBudgetBtn:'Usu≈Ñ Bud≈ºet',confirmDeleteBudget:'UsunƒÖƒá CA≈ÅY bud≈ºet?',createNewBudget:'Nowy Bud≈ºet',newBudgetPlaceholder:'np. Wakacje',createBtn:'Utw√≥rz',budgetCreated:'Utworzono!',forgotPassword:'Zapomnia≈Çe≈õ has≈Ça?',forgotPasswordSuccess:'Wys≈Çano!',budgetVsActual:'Plan vs Wydatki'},en:{welcome:"Welcome",login:"Log In",register:"Register",email:"Email",password:"Password",name:"Name",loginBtn:"Log In",registerBtn:"Register",logout:"Logout",authErrorLogin:"Error",authErrorRegister:"Error",exportCSV:"Export",defaultBudget:"My Budget",dashboardTitle:'Budget Dashboard',leftToSpend:'Left to Spend',totalIncome:'Total Income',totalExpenses:'Total Expenses',spendingAnalysis:'Analysis',budgetVsSpent:'Budget vs Spent',budgetCategories:'Categories',addTransaction:'Add Trans',recentTransactions:'Recent',manageBudget:'Manage Budget',yearlySummary:'Summary',manageCategories:'Manage Cats',addTransactionBtn:'Add',description:'Desc',descriptionPlaceholder:'e.g. Food',amount:'Amount',category:'Category',selectCategory:'Select...',date:'Date',noTransactions:'No trans.',spentOf:'spent of',budgeted:'Budgeted',manageCategoriesTitle:'Cats',manageBudgetTitle:'Budget',newCategoryPlaceholder:'New',addCategoryBtn:'Add',cancelEditBtn:'Cancel',saveChangesBtn:'Save',edit:'Edit',delete:'Del',yearlySummaryTitle:'Summary',month:'Month',savings:'Savings',total:'TOTAL',transactionAdded:'Added!',transactionDeleted:'Deleted.',budgetUpdated:'Updated.',invalidAmount:'Invalid.',categoryAdded:'Added.',categoryUpdated:'Updated.',categoryDeleted:'Deleted.',categoryDeleteError:'Has trans.',fillAllFields:'Fill all.',invalidCategory:'Select cat.',newMonthSheet:'New month.',confirmDelete:'Sure?',chartBudgeted:'Budget',chartSpent:'Spent',catTypeIncome:'Income',catTypeExpense:'Expense',catTypeBill:'Bill',catTypeDebt:'Debt',catTypeSavings:'Savings',catGroupIncome:'Income',catGroupExpense:'Expenses',catGroupBill:'Bills',catGroupDebt:'Debt',catGroupSavings:'Savings',monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],unknownUser:'?',deletedCategory:'Deleted',transactionSaveError:'Error.',clickToEditBudget:'Edit',deleteTransactionTooltip:'Del',budgetFor:'Budget for',allUsers:'All Users',langPlTooltip:'PL',langEnTooltip:'EN',currPlnTooltip:'PLN',currEurTooltip:'EUR',personalBudget:'Personal',budgetName:'Name',saveBtn:'Save',inviteUser:'Invite',inviteUserDesc:'Email',inviteBtn:'Invite',usersInBudget:'Users',inviteSuccess:'Invited!',inviteErrorUserNotFound:'Not found.',inviteErrorAlreadyMember:'Member.',inviteErrorGeneric:'Error.',budgetNameUpdated:'Updated.',dangerZone:'Danger',deleteBudgetDesc:'Permanent.',deleteBudgetBtn:'Delete',confirmDeleteBudget:'Delete ALL?',createNewBudget:'New Budget',newBudgetPlaceholder:'e.g. Holiday',createBtn:'Create',budgetCreated:'Created!',forgotPassword:'Forgot?',forgotPasswordSuccess:'Sent!',budgetVsActual:'Budget vs Actual'}};
            
            function i18n(k, r={}) { let t=translations[currentLang][k]||k; for(const[p,v]of Object.entries(r))t=t.replace(`{${p}}`,v); return t; }
            function formatCurrency(v) { const l=currentLang==='pl'?'pl-PL':'en-IE'; return new Intl.NumberFormat(l, { style:'currency', currency:currentCurrency }).format(v||0); }
            function formatDate(d) { const l=currentLang==='pl'?'pl-PL':'en-GB'; return new Date(d).toLocaleDateString(l); }
            function showMessage(k, t='success', r={}) { const mb=document.getElementById('message-box'); mb.textContent=i18n(k,r); mb.className=`p-4 text-sm rounded-lg ${t==='success'?'bg-teal-100 text-teal-900':'bg-red-100 text-red-900'}`; mb.classList.remove('hidden'); setTimeout(()=>mb.classList.add('hidden'),3000); }
            function showModal(id) { const el=document.getElementById(id); el.classList.remove('hidden'); setTimeout(()=>{el.classList.remove('opacity-0');el.querySelector('.modal-content').classList.remove('scale-95','opacity-0');},10); }
            function hideModal(id) { const el=document.getElementById(id); el.classList.add('opacity-0'); el.querySelector('.modal-content').classList.add('scale-95', 'opacity-0'); setTimeout(()=>el.classList.add('hidden'),300); }

            // --- LOGIKA STARTOWA ---
            function initAuthListener() {
                if(unsubscribeAuth) unsubscribeAuth();
                unsubscribeAuth = auth.onAuthStateChanged(async (user) => {
                    if (user) { currentUser = user; await loadAllUsers(); startApp(); } else { currentUser = null; stopApp(); }
                });
            }

            function startApp() { document.getElementById('auth-container').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); document.getElementById('fab-add-transaction').classList.remove('hidden'); attachUserBudgetsListener(); populateDateControls(); }
            function stopApp() { document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); document.getElementById('fab-add-transaction').classList.add('hidden'); if(unsubscribeBudgetsList) unsubscribeBudgetsList(); if(unsubscribeActiveBudget) unsubscribeActiveBudget(); currentBudgetId=null; }

            async function loadAllUsers() { try { const s=await db.collection('users').get(); s.forEach(d=>localUsers[d.id]=d.data().name||d.data().email); if(!localUsers[currentUser.uid]) localUsers[currentUser.uid]=currentUser.email.split('@')[0]; } catch(e){console.error(e);} }

            // --- LOGIKA DANYCH ---
            function attachUserBudgetsListener() {
                if(unsubscribeBudgetsList) unsubscribeBudgetsList();
                unsubscribeBudgetsList = db.collection('budgets').where('members', 'array-contains', currentUser.uid).onSnapshot(async (snapshot) => {
                    if(snapshot.empty) { await createPersonalBudget(currentUser.uid, localUsers[currentUser.uid]||currentUser.email); return; }
                    userBudgets = snapshot.docs.map(d => ({id:d.id, ...d.data()}));
                    userBudgets.sort((a,b)=> (b.members.length>1)-(a.members.length>1)); // Wsp√≥lne na g√≥rze
                    const sel = document.getElementById('budget-select'); sel.innerHTML='';
                    userBudgets.forEach(b => sel.add(new Option(b.name, b.id)));
                    if(!currentBudgetId || !userBudgets.some(b=>b.id===currentBudgetId)) currentBudgetId=userBudgets[0].id;
                    sel.value=currentBudgetId; attachActiveBudgetListeners(currentBudgetId);
                });
            }

            function attachActiveBudgetListeners(bid) {
                if(unsubscribeActiveBudget) unsubscribeActiveBudget();
                const ref = db.collection('budgets').doc(bid);
                const l = [];
                l.push(ref.collection('transactions').onSnapshot(s=>{ localTransactions=s.docs.map(d=>({id:d.id,...d.data()})); updateAllUI(); }));
                l.push(ref.collection('categories').onSnapshot(s=>{ localCategories=s.docs.map(d=>({id:d.id,...d.data()})); if(localCategories.length===0) seedDefaultCategories(bid); updateAllUI(); }));
                l.push(ref.collection('monthlyBudgets').onSnapshot(s=>{ localMonthlyBudgets={}; s.forEach(d=>localMonthlyBudgets[d.id]=d.data()); updateAllUI(); }));
                l.push(ref.onSnapshot(d=>{ if(d.exists) { localBudgetMembers=d.data().members||[]; updateAllUI(); } }));
                unsubscribeActiveBudget = () => l.forEach(u => u());
            }

            async function createPersonalBudget(uid, name) {
                const res = await db.collection('budgets').add({name:`${i18n('personalBudget')} - ${name}`, members:[uid], owner:uid});
                await seedDefaultCategories(res.id); return res.id;
            }

            async function seedDefaultCategories(bid) {
                const ref = db.collection('budgets').doc(bid).collection('categories');
                if ((await ref.limit(1).get()).empty) { 
                    const batch = db.batch(); 
                    const cats = currentLang==='pl'?[{name:'Wyp≈Çata',type:'Income',budgeted:4500},{name:'Czynsz',type:'Bill',budgeted:1800},{name:'Jedzenie',type:'Expense',budgeted:600}]:[{name:'Paycheck',type:'Income',budgeted:4500},{name:'Rent',type:'Bill',budgeted:1800},{name:'Food',type:'Expense',budgeted:600}]; 
                    cats.forEach(c => batch.set(ref.doc(), c)); await batch.commit(); 
                }
            }

            // --- RENDEROWANIE I OBLICZENIA ---
            function calculateAll() {
                const mVal = document.getElementById('month-select').value, yVal = document.getElementById('year-select').value;
                currentMonthKey = `${mVal}-${yVal}`;
                const mTrans = localTransactions.filter(t => { const d=new Date(t.date); return d.getMonth()==mVal && d.getFullYear()==yVal; });
                const fTrans = mTrans.filter(t => !currentFilterUserId || t.userId===currentFilterUserId);
                
                let totalInc=0, totalExp=0;
                const cats = localCategories.map(c => {
                    const bud = localMonthlyBudgets[currentMonthKey]?.[c.id] || 0;
                    const act = fTrans.filter(t=>t.categoryId===c.id).reduce((a,b)=>a+b.amount,0);
                    const users = {}; 
                    new Set([...localBudgetMembers, ...mTrans.map(t=>t.userId)]).forEach(u => {
                        users[u] = mTrans.filter(t=>t.categoryId===c.id && t.userId===u).reduce((a,b)=>a+b.amount,0);
                    });
                    return { ...c, actual:act, budgeted:bud, remaining:bud-act, users };
                });

                cats.forEach(c => {
                     const val = (c.type==='Income') ? c.actual : 0;
                     const cost = (c.type!=='Income') ? c.actual : 0;
                     totalInc += val; totalExp += cost;
                });

                return { totalInc, totalExp, cats, fTrans };
            }

            function updateAllUI() {
                if(!currentUser || !currentBudgetId) return;
                const data = calculateAll();
                
                // Karty
                document.getElementById('summary-left-to-spend').textContent = formatCurrency(data.totalInc - data.totalExp);
                document.getElementById('summary-spent-so-far').textContent = formatCurrency(data.totalExp);
                document.getElementById('summary-total-income').textContent = formatCurrency(data.totalInc);
                
                const incomeCats = data.cats.filter(c=>c.type==='Income');
                document.getElementById('summary-income-actual').textContent = formatCurrency(incomeCats.reduce((a,b)=>a+b.actual,0));
                document.getElementById('summary-income-budgeted').textContent = formatCurrency(incomeCats.reduce((a,b)=>a+b.budgeted,0));

                const expCats = data.cats.filter(c=>c.type!=='Income');
                document.getElementById('summary-expenses-actual').textContent = formatCurrency(expCats.reduce((a,b)=>a+b.actual,0));
                document.getElementById('summary-expenses-budgeted').textContent = formatCurrency(expCats.reduce((a,b)=>a+b.budgeted,0));

                // Tabele
                const types = ['Income','Expense','Bill','Debt','Savings'];
                const tKeys = ['catGroupIncome','catGroupExpense','catGroupBill','catGroupDebt','catGroupSavings'];
                containerIds.forEach((id,i) => {
                    const fCats = data.cats.filter(c=>c.type===types[i]);
                    if(fCats.length===0) { document.getElementById(id).innerHTML=''; return; }
                    document.getElementById(id).innerHTML = `<div class="space-y-2"><h3 class="text-base font-semibold text-white tracking-wider uppercase">${i18n(tKeys[i])}</h3><div class="divide-y divide-gray-700">` + 
                    fCats.map(c => {
                        const p = c.budgeted>0 ? Math.min(100, (c.actual/c.budgeted)*100) : 0;
                        const col = c.type==='Income'?'bg-teal-500':(p>90?'bg-red-500':'bg-purple-500');
                        let uHtml = '';
                        if(c.type!=='Income') {
                            const spans = localBudgetMembers.map(u => ({id:u,v:c.users[u]||0})).filter(o=>o.v>0).map(o=>`<span>${localUsers[o.id]||'?'}: ${formatCurrency(o.v)}</span>`).join(' ');
                            if(spans) uHtml = `<div class="flex justify-end text-xs text-gray-500 space-x-3 pt-1">${spans}</div>`;
                        }
                        return `<div class="py-2"><div class="flex justify-between text-sm mb-1"><span class="text-gray-200">${c.name}</span><span class="text-gray-400">${formatCurrency(c.actual)} / <span class="budget-value" data-id="${c.id}" title="${i18n('clickToEditBudget')}">${formatCurrency(c.budgeted)}</span></span></div><div class="w-full progress-bar rounded-full h-2"><div class="${col} progress h-2 rounded-full" style="width:${p}%"></div></div>${uHtml}</div>`;
                    }).join('') + '</div></div>';
                });

                // Lista
                const tList = document.getElementById('transaction-list-container');
                tList.innerHTML = data.fTrans.length ? '' : `<p class="text-gray-400">${i18n('noTransactions')}</p>`;
                data.fTrans.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(t => {
                    const c = localCategories.find(x=>x.id===t.categoryId);
                    const col = (c && c.type==='Income') ? 'text-teal-400' : 'text-gray-200';
                    const sign = (c && c.type==='Income') ? '+' : '-';
                    tList.insertAdjacentHTML('beforeend', `<div class="flex items-center justify-between py-3 border-b border-gray-700/50"><div class="flex-grow"><p class="font-medium text-white">${t.description}</p><p class="text-sm text-gray-400">${c?c.name:'?'} ‚Ä¢ ${localUsers[t.userId]||'?'} ‚Ä¢ ${formatDate(t.date)}</p></div><span class="font-medium text-lg ${col} ml-4">${sign}${formatCurrency(t.amount)}</span><button data-id="${t.id}" class="delete-trans-btn text-red-500 hover:text-red-300 ml-2">√ó</button></div>`);
                });
                
                // Filtry
                const uSel = document.getElementById('filter-user-select');
                const oldVal = uSel.value; uSel.innerHTML = `<option value="">${i18n('allUsers')}</option>`;
                localBudgetMembers.forEach(uid => uSel.add(new Option(localUsers[uid]||'?', uid)));
                uSel.value = oldVal;

                // Wykresy
                const pieCtx = document.getElementById('spendingDoughnutChart').getContext('2d');
                if(spendingDoughnutChart) spendingDoughnutChart.destroy();
                const pieD = data.cats.filter(c=>c.type!=='Income' && c.actual>0);
                spendingDoughnutChart = new Chart(pieCtx, {type:'doughnut',data:{labels:pieD.map(c=>c.name),datasets:[{data:pieD.map(c=>c.actual),backgroundColor:['#14b8a6','#ec4899','#a855f7','#f59e0b','#3b82f6'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'70%',plugins:{legend:{position:'bottom',labels:{color:'#d1d5db'}}}}});

                const barCtx = document.getElementById('budgetBarChart').getContext('2d');
                if(budgetBarChart) budgetBarChart.destroy();
                const barD = data.cats.filter(c=>c.type==='Expense');
                budgetBarChart = new Chart(barCtx, {type:'bar',data:{labels:barD.map(c=>c.name),datasets:[{label:i18n('chartBudgeted'),data:barD.map(c=>c.budgeted),backgroundColor:'#374151',borderRadius:4},{label:i18n('chartSpent'),data:barD.map(c=>c.actual),backgroundColor:'#a855f7',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,grid:{color:'#374151'}},x:{grid:{display:false}}},plugins:{legend:{labels:{color:'#d1d5db'}}}}});
            }

            function populateDateControls() {
                const mSel = document.getElementById('month-select'), ySel = document.getElementById('year-select');
                const m = i18n('monthNames'), y = new Date().getFullYear();
                mSel.innerHTML=''; (Array.isArray(m)?m:Object.values(m)).forEach((n,i)=>mSel.add(new Option(n,i)));
                ySel.innerHTML=''; [y-1,y,y+1].forEach(n=>ySel.add(new Option(n,n)));
                if(!currentMonthKey) currentMonthKey = `${new Date().getMonth()}-${y}`;
                const [cm, cy] = currentMonthKey.split('-'); mSel.value=cm; ySel.value=cy;
            }

            // --- EVENT LISTENERS ---
            document.getElementById('login-form').onsubmit = async (e) => {
                e.preventDefault();
                try { await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); } 
                catch(err){ document.getElementById('auth-error').textContent=i18n('authErrorLogin'); document.getElementById('auth-error').classList.remove('hidden'); }
            };
            document.getElementById('logout-btn').onclick = () => auth.signOut();
            
            document.getElementById('month-select').onchange = function() { currentMonthKey=`${this.value}-${document.getElementById('year-select').value}`; updateAllUI(); };
            document.getElementById('year-select').onchange = function() { currentMonthKey=`${document.getElementById('month-select').value}-${this.value}`; updateAllUI(); };
            document.getElementById('filter-user-select').onchange = function() { currentFilterUserId=this.value||null; updateAllUI(); };
            document.getElementById('budget-select').onchange = function() { currentBudgetId=this.value; attachActiveBudgetListeners(currentBudgetId); };

            document.getElementById('fab-add-transaction').onclick = () => { 
                const sel = document.getElementById('trans-category'); sel.innerHTML='';
                localCategories.forEach(c => sel.add(new Option(c.name, c.id)));
                showModal('transaction-modal'); 
            };
            document.getElementById('close-transaction-modal').onclick = () => hideModal('transaction-modal');
            document.getElementById('transaction-form').onsubmit = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const cat = localCategories.find(c=>c.id===fd.get('trans-category'));
                await db.collection('budgets').doc(currentBudgetId).collection('transactions').add({
                    date: fd.get('trans-date'), description: fd.get('trans-description'), amount: parseFloat(fd.get('trans-amount')), categoryId: cat.id, userId: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                hideModal('transaction-modal');
            };
            document.getElementById('transaction-list-container').onclick = async (e) => { if(e.target.classList.contains('delete-trans-btn') && confirm(i18n('confirmDelete'))) { await db.collection('budgets').doc(currentBudgetId).collection('transactions').doc(e.target.dataset.id).delete(); }};

            // Budget Manager Logic
            document.getElementById('manage-budget-btn').onclick = () => {
                document.getElementById('budget-user-list').innerHTML = localBudgetMembers.map(u=>`<div class="p-2 bg-gray-700 rounded text-white">${localUsers[u]||u}</div>`).join('');
                const dBtn = document.getElementById('load-demo-data-btn');
                if(currentUser.email === 'mwojciechowski808@gmail.com') {
                     dBtn.parentElement.classList.remove('hidden');
                     dBtn.onclick = async () => {
                        if(!confirm("Wgraƒá?")) return;
                        // AUTO-ADD NATALIA
                        const nataliaSnap = await db.collection('users').where('email','==','pasierska.natalia@gmail.com').get();
                        const nataliaId = !nataliaSnap.empty ? nataliaSnap.docs[0].id : null;
                        if(nataliaId && !localBudgetMembers.includes(nataliaId)) await db.collection('budgets').doc(currentBudgetId).update({members:firebase.firestore.FieldValue.arrayUnion(nataliaId)});
                        
                        const batch = db.batch(); const tr = db.collection('budgets').doc(currentBudgetId).collection('transactions');
                        const demo = [
                            {d:'Wyp≈Çata Mich',a:8600,u:currentUser.uid},{d:'Wyp≈Çata Nacia',a:7000,u:nataliaId||currentUser.uid},
                            {d:'Czynsz',a:703,u:currentUser.uid},{d:'Media',a:190,u:currentUser.uid},
                            {d:'Paliwo',a:220,u:currentUser.uid},{d:'Kolacja',a:150,u:nataliaId||currentUser.uid}
                        ];
                        demo.forEach(i => {
                            const cat = localCategories.find(c=>c.name.includes(i.d.split(' ')[0])) || localCategories[0];
                            batch.set(tr.doc(), {date:'2025-11-01', description:i.d, amount:i.a, categoryId:cat.id, userId:i.u, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
                        });
                        await batch.commit();
                     };
                } else { dBtn.parentElement.classList.add('hidden'); }
                showModal('budget-manager-modal');
            };
            document.getElementById('close-budget-modal').onclick = () => hideModal('budget-manager-modal');
            
            document.getElementById('manage-categories-btn').onclick = () => {
                document.getElementById('category-manager-list').innerHTML = localCategories.map(c => `<div class="flex justify-between p-2 bg-gray-700 rounded mb-2 text-white"><span>${c.name} (${formatCurrency(c.budgeted)})</span><button class="text-red-400" onclick="deleteCat('${c.id}')">Usu≈Ñ</button></div>`).join('');
                showModal('category-manager-modal');
            };
            document.getElementById('close-category-modal').onclick = () => hideModal('category-manager-modal');
            
            window.deleteCat = async (id) => { if(confirm("Usu≈Ñ?")) await db.collection('budgets').doc(currentBudgetId).collection('categories').doc(id).delete(); };

            document.getElementById('category-form').onsubmit = async (e) => {
                e.preventDefault();
                await db.collection('budgets').doc(currentBudgetId).collection('categories').add({
                    name: document.getElementById('cat-form-name').value,
                    budgeted: parseFloat(document.getElementById('cat-form-budgeted').value),
                    type: document.getElementById('cat-form-type').value
                });
            };
            const ct = document.getElementById('cat-form-type');
            ['Income','Expense','Bill','Debt','Savings'].forEach(t=>ct.add(new Option(t,t)));
            
            containerIds.forEach(id => document.getElementById(id).onclick = async (e) => {
                if(e.target.classList.contains('budget-value')) {
                    const cid = e.target.dataset.id;
                    const val = prompt("Nowy bud≈ºet:", localMonthlyBudgets[currentMonthKey]?.[cid]||0);
                    if(val!==null) await db.collection('budgets').doc(currentBudgetId).collection('monthlyBudgets').doc(currentMonthKey).set({[cid]:parseFloat(val)},{merge:true});
                }
            });
            
            const setLang = (lang) => { currentLang = lang; document.documentElement.lang = lang; updateTexts(); };
            const setCurr = (curr) => { currentCurrency = curr; updateTexts(); };
            const updateTexts = () => {
                document.querySelectorAll('[data-i18n-key]').forEach(el => {
                    const k = el.dataset.i18nKey;
                    if(el.tagName==='INPUT') el.placeholder = i18n(k);
                    else if(el.title && k.includes('Tooltip')) el.title = i18n(k);
                    else el.textContent = i18n(k);
                });
                ['auth-lang','lang'].forEach(p => { document.getElementById(`${p}-pl`)?.classList.toggle('active', currentLang==='pl'); document.getElementById(`${p}-en`)?.classList.toggle('active', currentLang==='en'); });
                ['auth-curr','curr'].forEach(p => { document.getElementById(`${p}-pln`)?.classList.toggle('active', currentCurrency==='PLN'); document.getElementById(`${p}-eur`)?.classList.toggle('active', currentCurrency==='EUR'); });
                if(currentUser) { populateDateControls(); updateAllUI(); }
            };
            document.getElementById('auth-lang-pl').onclick = () => setLang('pl'); document.getElementById('auth-lang-en').onclick = () => setLang('en'); document.getElementById('auth-curr-pln').onclick = () => setCurr('PLN'); document.getElementById('auth-curr-eur').onclick = () => setCurr('EUR');
            document.getElementById('lang-pl').onclick = () => setLang('pl'); document.getElementById('lang-en').onclick = () => setLang('en'); document.getElementById('curr-pln').onclick = () => setCurr('PLN'); document.getElementById('curr-eur').onclick = () => setCurr('EUR');
            document.getElementById('delete-budget-btn').onclick = async () => { if(confirm("UsunƒÖƒá?")) { await db.collection('budgets').doc(currentBudgetId).delete(); hideModal('budget-manager-modal'); } };

            initAuthListener();
        });
    </script>
</body>
</html>
